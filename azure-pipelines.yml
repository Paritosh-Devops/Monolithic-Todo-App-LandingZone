trigger: 
  branches:
    include:
    - main
    - feature/*
  # paths:
  #   include:
  #     - '$(workDir)'
  

pool: Agent-Hub

variables:
- group: pcslSecretVarGroups
- name: serviceConnection
  value: pcsl-serviccon-ind-infra

stages:
- stage: PreCommitStage
  displayName: Pre Commit Stage
  jobs:
  - job: TerraformInitValidateJob
    displayName: Terraform Init and Validate Job
    steps:

    - task: TerraformInstaller@1
      displayName: Terraform Installer
      inputs:
        terraformVersion: '1.14.3'
    - task: TerraformTask@5
      displayName: Terraform Init
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(workDir)'
        backendServiceArm: 'pcsl-serviccon-ind-infra'
        backendAzureRmOverrideSubscriptionID: 'e5c8e042-8d4d-4e69-8511-a29fb378ec23'
        backendAzureRmResourceGroupName: 'pcsl-backend-in-rg'
        backendAzureRmStorageAccountName: 'pcslstgforbkend2025'
        backendAzureRmContainerName: 'pcsl-backend-container'
        backendAzureRmKey: 'dev.terraform.tfstate'
    
    - task: TerraformTask@5
      displayName: Terraform Validate
      inputs:
        provider: 'azurerm'
        command: 'validate'
        workingDirectory: '$(workDir)'
    
  - job: TerraformFmt
    steps:
    - task: TerraformTask@5
      displayName: Terraform Fmt
      inputs:
        provider: 'azurerm'
        command: 'custom'
        workingDirectory: '$(workDir)'
        outputTo: 'console'
        customCommand: 'fmt'
        environmentServiceNameAzureRM: '$(serviceConnection)'
        environmentAzureRmOverrideSubscriptionID: 'e5c8e042-8d4d-4e69-8511-a29fb378ec23'
  
  
  - job: TerraformPlan
    dependsOn: TerraformInitValidateJob
    steps:
    
    - task: TerraformTask@5
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(workDir)'
        environmentServiceNameAzureRM: 'pcsl-serviccon-ind-infra'
        
- stage: ScanningAndLinting
  displayName: Scanning and Linting
  jobs:
  - job: TerraformLinting
    steps:
    - task: PowerShell@2
      displayName: Install and Run Tflint
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "==============================="
                Write-Host " Installing TFLint on Windows "
                Write-Host "==============================="
          
                $tflintVersion = "v0.60.0"
                $tflintUrl = "https://github.com/terraform-linters/tflint/releases/download/$tflintVersion/tflint_windows_amd64.zip"
          
                $installDir = "$env:USERPROFILE\tflint"
                $zipPath    = "$installDir\tflint.zip"
          
                # Create directory
                if (!(Test-Path $installDir)) {
                    New-Item -ItemType Directory -Path $installDir | Out-Null
                }
          
                Write-Host "Downloading TFLint..."
                Invoke-WebRequest -Uri $tflintUrl -OutFile $zipPath
          
                Write-Host "Extracting TFLint..."
                Expand-Archive -Path $zipPath -DestinationPath $installDir -Force
          
                # Add to PATH for current pipeline
                $env:PATH = "$installDir;$env:PATH"
          
                Write-Host "Verifying TFLint installation..."
                tflint --version
          
                Write-Host "==============================="
                Write-Host " Running TFLint "
                Write-Host "==============================="
          
                cd "$(workDir)"
          
                tflint --init
                tflint
  - job: TerraformSecurityScanning
    displayName: Tfsec
    steps:
    - task: tfsec@1
      displayName: TfSecScanning
      inputs:
        version: 'v1.26.0'
        dir: '$(workDir)'

- stage: InfraCostAnalysis
  displayName: Infra Cost Analysis
  jobs:
  - job: InfraCostAnalysis
    displayName: Infra Cost Analysis Job
    steps:
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "==============================="
                Write-Host " Initiating Infra Cost Analysis"
                Write-Host "==============================="
          
                # Inject Infracost API Token
                $env:INFRACOST_API_KEY = "$(apitoken)"
          
                # Show which directory is being scanned
                Write-Host "Scanning path: $(workDir)"
          
                # Verify authentication
                infracost auth status
          
                # Run Infracost
                infracost breakdown `
                  --path . `
                  --format table
        workingDirectory: '$(workDir)'

- stage: PlanAndReview
  displayName: Plan & Review Stage
  jobs:
  - job: PlanAndReviewJob
    steps:
    - task: TerraformInstaller@1
      displayName: TerraformInstaller
      inputs:
        terraformVersion: '1.14.3'
    - task: TerraformTask@5
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(workDir)'
        backendServiceArm: 'pcsl-serviccon-ind-infra'
        backendAzureRmOverrideSubscriptionID: 'e5c8e042-8d4d-4e69-8511-a29fb378ec23'
        backendAzureRmResourceGroupName: 'pcsl-backend-in-rg'
        backendAzureRmStorageAccountName: 'pcslstgforbkend2025'
        backendAzureRmContainerName: 'pcsl-backend-container'
        backendAzureRmKey: 'dev.terraform.tfstate'
    - task: TerraformTask@5
      displayName: Terraform Plan Task
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(workDir)'
        environmentServiceNameAzureRM: 'pcsl-serviccon-ind-infra'
        environmentAzureRmOverrideSubscriptionID: 'e5c8e042-8d4d-4e69-8511-a29fb378ec23'

- stage: ManualValidation
  displayName: Approval & Governance 
  jobs:
  - job: ManualValidation
    displayName: Manual Validation job
    pool: server
    steps:
    - task: ManualValidation@1
      displayName: Manual Valiidation task
      inputs:
        notifyUsers: 'Paritosh6387@gmail.com'
        instructions: 'Check the code and approve , Galat approve kiye to Job khatre me ...'
  
- stage: DeploymentApplyStage
  displayName: Terraform Deployment Stage
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
  dependsOn: ManualValidation
  jobs:
  - job: TerraformApplyJob
    
    displayName: Terraform Apply Job
    steps:
    - task: TerraformTask@5
      displayName: InitBeforeApply
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(workDir)'
        backendServiceArm: 'pcsl-serviccon-ind-infra'
        backendAzureRmOverrideSubscriptionID: 'e5c8e042-8d4d-4e69-8511-a29fb378ec23'
        backendAzureRmResourceGroupName: 'pcsl-backend-in-rg'
        backendAzureRmStorageAccountName: 'pcslstgforbkend2025'
        backendAzureRmContainerName: 'pcsl-backend-container'
        backendAzureRmKey: 'dev.terraform.tfstate'
    - task: TerraformTask@5
      displayName: Apply Task
      inputs:
        provider: 'azurerm'
        command: 'apply'
        workingDirectory: '$(workDir)'
        commandOptions: '-auto-approve'
        environmentServiceNameAzureRM: 'pcsl-serviccon-ind-infra'
        environmentAzureRmOverrideSubscriptionID: 'e5c8e042-8d4d-4e69-8511-a29fb378ec23'